{% extends "layout.html" %}
{% load getattribute %}
{% block content %}
<main class="container" x-data="{ search: '' }">

  <h1>{{ title }}</h1>
  {% if model and show_actions|default:True %}
  <a href="{% url 'new' model %}" role="button"><i class="material-icons">add</i> Nuevo</a>
  {% endif %}
  <hr>

  <div id="gridjs-table" style="width: 100%;"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const showActions = {% if show_actions|default:True %}true{% else %}false{% endif %};
        const headers = [
        {% for field in fields %}
          '{{ field|escapejs }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
        {% if show_actions|default:True %},'Acciones'{% endif %}
      ];
       const rawData = [
        {% for item in page_obj %}
          {% if show_actions|default:True %}{% url "edit" model item.id as edit_url %}{% endif %}
          [
            {% for col in columns %}
              '{{ item|format_value:col|escapejs }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
            {% if show_actions|default:True %},'{{ edit_url|escapejs }}'{% endif %}
          ]{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];
      // Transformar rawData en data, convirtiendo la última columna (URL) en elemento DOM si hay acciones
      const data = rawData.map(row => {
        return row.map((cell, cellIndex) => {
          // Si hay acciones y es la última columna, crear enlace
          if (showActions && cellIndex === row.length - 1) {
            const newLink = document.createElement('a');
            newLink.href = cell;
            newLink.innerHTML = '<i class="material-icons">edit</i>';
            newLink.title = 'Editar';
            return newLink;
          }
          // Para otras columnas, ya es string
          return cell;
        });
      });
      
      // Si no hay datos, mostrar mensaje
      if (data.length === 0) {
        document.getElementById('gridjs-table').innerHTML = '<p>No hay registros.</p>';
        return;
      }
      
      // Configurar columnas con sorting personalizado
      const columns = headers.map((header, index) => {
        // Si hay acciones y es la última columna, no es ordenable
        if (showActions && index === headers.length - 1) {
          return { 
            name: header, 
            sort: false,
            formatter: (cell) => cell
          };
        }
        return {
          name: header,
          sort: {
            icon: (order) => {
              const icon = document.createElement('i');
              icon.className = 'material-icons gridjs-sort-icon';
              if (order === 'asc') {
                icon.textContent = 'arrow_upward';
              } else if (order === 'desc') {
                icon.textContent = 'arrow_downward';
              } else {
                icon.textContent = 'unfold_more';
              }
              return icon;
            }
          }
        };
      });
      
      new gridjs.Grid({
        columns: columns,
        data: data,
        search: true,
        pagination: {
          limit: 20,
          summary: true,
        },
        sort: true,
        language: {
          search: {
            placeholder: 'Buscar...'
          },
          pagination: {
            previous: 'Anterior',
            next: 'Siguiente',
            showing: 'Mostrando',
            results: () => 'registros'
          }
        }
      }).render(document.getElementById('gridjs-table'));
      document.querySelectorAll(".gridjs-pages").forEach(el => el.setAttribute("role", "group"));
    });
  </script>
  <style>
    .gridjs-sort {
      display: none;
    }
    .gridjs-th-content {
      cursor: pointer;
    }
    .gridjs-th {
      min-width: 0 !important;
    }
  </style>
</main>
{% endblock %}
