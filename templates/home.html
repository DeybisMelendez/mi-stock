{% extends "layout.html" %}
{% block title %}Home{% endblock %}

{% block content %}

<main class="container">

  <h1>Dashboard del negocio</h1>


  <!-- ======= ESTADÍSTICAS ======= -->
  <section>
    <h2>Resumen general</h2>

    <ul>
      <li><strong>Ingresos totales:</strong> ${{ total_income }}</li>
      <li><strong>Ingresos últimos 30 días:</strong> ${{ total_income_30 }}</li>
      <li><strong>Ventas totales:</strong> {{ total_sales_count }}</li>
      <li><strong>Valor inventario actual:</strong> ${{ inventory_value }}</li>
      <li><strong>Promedio ticket:</strong> ${{ avg_ticket }}</li>
      <li><strong>Margen bruto total:</strong> ${{ margin_gross_total }}</li>
      <li><strong>Ingresos mes actual:</strong> ${{ this_month_income }}</li>
      <li><strong>Ingresos mes anterior:</strong> ${{ last_month_income }}</li>
    </ul>
  </section>


  <!-- TOP PRODUCTOS -->
  <section>
    <h2>Top productos más vendidos</h2>

    <div id="top-products-grid" class="gridjs-container"></div>
    <table id="top-products-table" class="gridjs-table" style="display:none">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Total vendido</th>
        </tr>
      </thead>
      <tbody>
        {% for item in top_products %}
        <tr>
          <td>{{ item.product__name }}</td>
          <td>{{ item.total_sold }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="2">No hay ventas aún</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>


  <!-- TOP 30 DÍAS -->
  <section>
    <h2>Top últimos 30 días</h2>

    <div id="top-products-30-grid" class="gridjs-container"></div>
    <table id="top-products-30-table" class="gridjs-table" style="display:none">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Total vendido</th>
        </tr>
      </thead>
      <tbody>
        {% for item in top_products_30 %}
        <tr>
          <td>{{ item.product__name }}</td>
          <td>{{ item.total_sold }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="2">No hay ventas aún</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>


  <!-- TOP CATEGORIAS -->
  <section>
    <h2>Top categorías</h2>

    <div id="top-categories-grid" class="gridjs-container"></div>
    <table id="top-categories-table" class="gridjs-table" style="display:none">
      <thead>
        <tr>
          <th>Categoría</th>
          <th>Vendidos</th>
        </tr>
      </thead>
      <tbody>
        {% for item in top_categories %}
        <tr>
          <td>{{ item.product__category__name }}</td>
          <td>{{ item.total_sold }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="2">No hay ventas aún</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>



  <!-- PRODUCTOS CON BAJO STOCK -->
  <section>
    <h2>Productos con bajo stock</h2>

    <ul>
      {% for p in low_stock %}
      <li>{{ p.name }} — {{ p.stock }} unidades</li>
      {% empty %}
      <li>No hay productos con bajo stock</li>
      {% endfor %}
    </ul>
  </section>
  
  <!-- INVENTARIO PROYECTADO -->
<section>
  <h2>Productos por agotar (estimado anual)</h2>

   <div id="business-projection-grid" class="gridjs-container"></div>
   <table id="business-projection-table" class="gridjs-table" style="display:none">
     <thead>
       <tr>
         <th>Producto</th>
         <th>Stock actual</th>
         <th>Vendidos últimos 12 meses</th>
         <th>Cada cuánto vendo una unidad</th>
         <th>Días estimados para agotar stock</th>
       </tr>
     </thead>
     <tbody>
       {% for row in business_projection %}
       <tr>
         <td>{{ row.product.name }}</td>
         <td>{{ row.product.stock }}</td>
         <td>{{ row.sold_365 }}</td>
         <td>
           {% if row.days_per_unit %}
             {{ row.days_per_unit|floatformat:1 }} días / unidad
           {% else %}
             —
           {% endif %}
         </td>
         <td>
           {% if row.days_to_runout %}
             {{ row.days_to_runout|floatformat:0 }} días
           {% else %}
             —
           {% endif %}
         </td>
       </tr>
       {% empty %}
       <tr>
         <td colspan="5">No hay datos suficientes para proyectar.</td>
       </tr>
       {% endfor %}
     </tbody>
   </table>
</section>



  <!-- GRÁFICO -->
  <section>
    <h2>Gráfico de productos más vendidos</h2>

    <canvas id="topChart" height="120"></canvas>
  </section>

</main>



<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const ctx = document.getElementById('topChart');

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: [{% for i in top_products %}"{{ i.product__name }}",{% endfor %}],
        datasets: [{
            label: 'Ventas',
            data: [{% for i in top_products %}{{ i.total_sold }},{% endfor %}],
        }]
    }
 });
 </script>

 <script>
   document.addEventListener('DOMContentLoaded', function() {
     // Para cada tabla con clase gridjs-table
     document.querySelectorAll('table.gridjs-table').forEach(function(table) {
       const tableId = table.id;
       const containerId = tableId.replace('-table', '-grid');
       const container = document.getElementById(containerId);
       if (!container) return;
       
       const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
       const rows = table.querySelectorAll('tbody tr');
       const data = Array.from(rows).map(row => {
         const cells = row.querySelectorAll('td');
         return Array.from(cells).map(cell => cell.innerHTML.trim());
       });
       
       if (data.length === 0) {
         container.innerHTML = '<p>No hay datos.</p>';
         return;
       }
       
       const columns = headers.map(header => ({ name: header }));
       
       new gridjs.Grid({
         columns: columns,
         data: data,
         search: true,
         pagination: data.length > 5 ? { limit: 5, summary: true } : false,
         sort: true,
         language: {
           search: {
             placeholder: 'Buscar...'
           },
           pagination: {
             previous: 'Anterior',
             next: 'Siguiente',
             showing: 'Mostrando',
             results: () => 'registros'
           }
         }
       }).render(container);
     });
   });
 </script>

 {% endblock %}
