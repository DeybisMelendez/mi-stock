{% extends "layout.html" %}
{% block content %}

<main class="container">
  
  <!-- ENCABEZADO -->
  <header style="margin-bottom: 2rem;">
    <h1>Dashboard del Negocio</h1>
    <p>Resumen de estadísticas para toma de decisiones - {{ today|date:"d/m/Y" }}</p>
  </header>

  <!-- KPI CARDS -->
  <section style="margin-bottom: 3rem;">
    <h2>Desempeño Financiero</h2>
    
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
      
      <!-- INGRESOS HOY -->
      <article style="padding: 1rem; border-left: 4px solid var(--primary);">
        <header>
          <h3 style="margin: 0 0 0.5rem 0;">Hoy</h3>
        </header>
        <p style="font-size: 1.5rem; font-weight: bold; margin: 0 0 0.5rem 0;">
          C$ {{ income_today|floatformat:2 }}
        </p>
        <footer style="font-size: 0.9rem; color: var(--muted-color);">
          {% if income_yesterday > 0 %}
            {% if growth_today > 0 %}
              <span style="color: var(--success)">↗ {{ growth_today|floatformat:1 }}%</span> vs ayer
            {% elif growth_today < 0 %}
              <span style="color: var(--error)">↘ {{ growth_today|floatformat:1 }}%</span> vs ayer
            {% else %}
              <span>→ Igual que ayer</span>
            {% endif %}
          {% else %}
            <span>Sin datos ayer</span>
          {% endif %}
          • {{ sales_count_today }} ventas
        </footer>
      </article>
      
      <!-- ÚLTIMOS 7 DÍAS -->
      <article style="padding: 1rem; border-left: 4px solid var(--secondary);">
        <header>
          <h3 style="margin: 0 0 0.5rem 0;">Últimos 7 días</h3>
        </header>
        <p style="font-size: 1.5rem; font-weight: bold; margin: 0 0 0.5rem 0;">
          C$ {{ income_last_7_days|floatformat:2 }}
        </p>
        <footer style="font-size: 0.9rem; color: var(--muted-color);">
          {% if income_previous_week > 0 %}
            {% if growth_week > 0 %}
              <span style="color: var(--success)">↗ {{ growth_week|floatformat:1 }}%</span> vs semana anterior
            {% elif growth_week < 0 %}
              <span style="color: var(--error)">↘ {{ growth_week|floatformat:1 }}%</span> vs semana anterior
            {% else %}
              <span>→ Igual que semana anterior</span>
            {% endif %}
          {% else %}
            <span>Sin datos semana anterior</span>
          {% endif %}
          • {{ sales_count_last_7_days }} ventas
        </footer>
      </article>
      
      <!-- MES ACTUAL -->
      <article style="padding: 1rem; border-left: 4px solid var(--contrast);">
        <header>
          <h3 style="margin: 0 0 0.5rem 0;">Mes Actual</h3>
        </header>
        <p style="font-size: 1.5rem; font-weight: bold; margin: 0 0 0.5rem 0;">
          C$ {{ income_this_month|floatformat:2 }}
        </p>
        <footer style="font-size: 0.9rem; color: var(--muted-color);">
          {% if income_last_month > 0 %}
            {% if growth_month > 0 %}
              <span style="color: var(--success)">↗ {{ growth_month|floatformat:1 }}%</span> vs mes anterior
            {% elif growth_month < 0 %}
              <span style="color: var(--error)">↘ {{ growth_month|floatformat:1 }}%</span> vs mes anterior
            {% else %}
              <span>→ Igual que mes anterior</span>
            {% endif %}
          {% else %}
            <span>Sin datos mes anterior</span>
          {% endif %}
          • Desde {{ month_start|date:"d/m" }}
        </footer>
      </article>
      
      <!-- ÚLTIMOS 30 DÍAS -->
      <article style="padding: 1rem; border-left: 4px solid var(--highlight);">
        <header>
          <h3 style="margin: 0 0 0.5rem 0;">Últimos 30 días</h3>
        </header>
        <p style="font-size: 1.5rem; font-weight: bold; margin: 0 0 0.5rem 0;">
          C$ {{ income_last_30_days|floatformat:2 }}
        </p>
        <footer style="font-size: 0.9rem; color: var(--muted-color);">
          <span>Margen: C$ {{ margin_last_30_days|floatformat:2 }}</span><br>
          <span>Gastos: C$ {{ expenses_last_30_days|floatformat:2 }}</span>
        </footer>
      </article>
      
    </div>
  </section>

  <!-- GRÁFICOS -->
  <section style="margin-bottom: 3rem;">
    <h2>Tendencias y Distribución</h2>
    
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
      
      <!-- GRÁFICO DE VENTAS ÚLTIMOS 7 DÍAS -->
      <article>
        <header>
          <h3>Ventas últimos 7 días</h3>
        </header>
        <canvas id="salesChart" height="200"></canvas>
      </article>
      
      <!-- GRÁFICO DE DISTRIBUCIÓN POR CATEGORÍA -->
      <article>
        <header>
          <h3>Ventas por categoría (30 días)</h3>
        </header>
        <canvas id="categoryChart" height="200"></canvas>
      </article>
      
    </div>
  </section>

  <!-- PRODUCTOS MÁS VENDIDOS -->
  <section style="margin-bottom: 3rem;">
    <h2>Productos Más Vendidos</h2>
    
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
      
      <!-- RESUMEN DEL MES -->
      <article>
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3>Top 5 del Mes</h3>
          <a href="{% url 'top_products' %}" role="button" style="font-size: 0.9rem;">Ver todos</a>
        </header>
        
        {% if top_products_month %}
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid var(--muted-border-color);">
              <th style="text-align: left; padding: 0.5rem;">Producto</th>
              <th style="text-align: right; padding: 0.5rem;">Cantidad</th>
              <th style="text-align: right; padding: 0.5rem;">Ingresos</th>
            </tr>
          </thead>
          <tbody>
            {% for product in top_products_month|slice:":5" %}
            <tr style="border-bottom: 1px solid var(--muted-border-color);">
              <td style="padding: 0.5rem;">{{ product.product__name }}</td>
              <td style="text-align: right; padding: 0.5rem;">{{ product.total_sold }}</td>
              <td style="text-align: right; padding: 0.5rem;">C$ {{ product.total_revenue|floatformat:2 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p>No hay ventas en el último mes.</p>
        {% endif %}
        
        <footer style="margin-top: 1rem; font-size: 0.9rem; color: var(--muted-color);">
          <p>Períodos: 
            <a href="{% url 'top_products_period' 'hoy' %}">Hoy</a> | 
            <a href="{% url 'top_products_period' 'semana' %}">Semana</a> | 
            <a href="{% url 'top_products_period' 'mes' %}">Mes</a> | 
            <a href="{% url 'top_products_period' 'total' %}">Total</a>
          </p>
        </footer>
      </article>
      
      <!-- RESUMEN DE LA SEMANA -->
      <article>
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3>Top 5 de la Semana</h3>
          <a href="{% url 'top_products_period' 'semana' %}" role="button" style="font-size: 0.9rem;">Ver todos</a>
        </header>
        
        {% if top_products_week %}
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid var(--muted-border-color);">
              <th style="text-align: left; padding: 0.5rem;">Producto</th>
              <th style="text-align: right; padding: 0.5rem;">Cantidad</th>
              <th style="text-align: right; padding: 0.5rem;">Ingresos</th>
            </tr>
          </thead>
          <tbody>
            {% for product in top_products_week|slice:":5" %}
            <tr style="border-bottom: 1px solid var(--muted-border-color);">
              <td style="padding: 0.5rem;">{{ product.product__name }}</td>
              <td style="text-align: right; padding: 0.5rem;">{{ product.total_sold }}</td>
              <td style="text-align: right; padding: 0.5rem;">C$ {{ product.total_revenue|floatformat:2 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p>No hay ventas en la última semana.</p>
        {% endif %}
        
        <footer style="margin-top: 1rem; font-size: 0.9rem; color: var(--muted-color);">
          <p>Resumen de los últimos 7 días</p>
        </footer>
      </article>
      
    </div>
  </section>

  <!-- MÉTRICAS DEL NEGOCIO -->
  <section>
    <h2>Métricas del Negocio</h2>
    
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
      
      <!-- COMPRAS MES ACTUAL -->
      <article style="padding: 1rem; border-left: 4px solid var(--primary);">
        <header>
          <h3 style="margin: 0 0 0.5rem 0;">Compras Mes Actual</h3>
        </header>
        <p style="font-size: 1.5rem; font-weight: bold; margin: 0 0 0.5rem 0;">
          C$ {{ purchases_this_month|floatformat:2 }}
        </p>
        <footer style="font-size: 0.9rem; color: var(--muted-color);">
          {% if purchases_last_month > 0 %}
            {% if purchases_growth > 0 %}
              <span style="color: var(--error)">↗ {{ purchases_growth|floatformat:1 }}%</span> vs mes anterior
            {% elif purchases_growth < 0 %}
              <span style="color: var(--success)">↘ {{ purchases_growth|floatformat:1 }}%</span> vs mes anterior
            {% else %}
              <span>→ Igual que mes anterior</span>
            {% endif %}
          {% else %}
            <span>Sin datos mes anterior</span>
          {% endif %}
        </footer>
      </article>
      
      <!-- COMPRAS ÚLTIMOS 30 DÍAS -->
      <article style="padding: 1rem; border-left: 4px solid var(--secondary);">
        <header>
          <h3 style="margin: 0 0 0.5rem 0;">Compras Últimos 30 días</h3>
        </header>
        <p style="font-size: 1.5rem; font-weight: bold; margin: 0 0 0.5rem 0;">
          C$ {{ purchases_last_30_days|floatformat:2 }}
        </p>
        <footer style="font-size: 0.9rem; color: var(--muted-color);">
          <span>Inversión en inventario</span>
        </footer>
      </article>
      
      <!-- GASTOS MES ACTUAL -->
      <article style="padding: 1rem; border-left: 4px solid var(--contrast);">
        <header>
          <h3 style="margin: 0 0 0.5rem 0;">Gastos Mes Actual</h3>
        </header>
        <p style="font-size: 1.5rem; font-weight: bold; margin: 0 0 0.5rem 0;">
          C$ {{ expenses_this_month|floatformat:2 }}
        </p>
        <footer style="font-size: 0.9rem; color: var(--muted-color);">
          {% if expenses_last_month > 0 %}
            {% if expenses_growth > 0 %}
              <span style="color: var(--error)">↗ {{ expenses_growth|floatformat:1 }}%</span> vs mes anterior
            {% elif expenses_growth < 0 %}
              <span style="color: var(--success)">↘ {{ expenses_growth|floatformat:1 }}%</span> vs mes anterior
            {% else %}
              <span>→ Igual que mes anterior</span>
            {% endif %}
          {% else %}
            <span>Sin datos mes anterior</span>
          {% endif %}
        </footer>
      </article>
      
      <!-- GASTOS ÚLTIMOS 30 DÍAS -->
      <article style="padding: 1rem; border-left: 4px solid var(--highlight);">
        <header>
          <h3 style="margin: 0 0 0.5rem 0;">Gastos Últimos 30 días</h3>
        </header>
        <p style="font-size: 1.5rem; font-weight: bold; margin: 0 0 0.5rem 0;">
          C$ {{ expenses_last_30_days|floatformat:2 }}
        </p>
        <footer style="font-size: 0.9rem; color: var(--muted-color);">
          <span>Gastos operativos</span>
        </footer>
      </article>
      
    </div>
  </section>

</main>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Gráfico de ventas últimos 7 días
const salesCtx = document.getElementById('salesChart').getContext('2d');
const salesChart = new Chart(salesCtx, {
    type: 'line',
    data: {
         labels: {{ daily_sales_labels_json|safe }},
        datasets: [{
            label: 'Ingresos (C$)',
             data: {{ daily_sales_values_json|safe }},
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'C$ ' + value.toLocaleString('es-NI');
                    }
                }
            }
        }
    }
});

// Gráfico de categorías
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
const categoryChart = new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
         labels: {{ category_labels_json|safe }},
        datasets: [{
             data: {{ category_values_json|safe }},
            backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#8AC926', '#1982C4'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'right',
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += 'C$ ' + context.parsed.toLocaleString('es-NI');
                        return label;
                    }
                }
            }
        }
    }
});
</script>

{% endblock %}